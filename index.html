<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE | Global Intelligence Monitor</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script async src="https://platform.twitter.com/widgets.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'p': {
                            'black': '#030506', 'darker': '#070a0d', 'dark': '#0a0e12',
                            'panel': '#0d1117', 'border': '#1b2430', 'text': '#e6edf3',
                            'muted': '#484f58', 'green': '#00ff88', 'cyan': '#00d4ff',
                            'orange': '#f97316', 'red': '#ef4444', 'critical': '#ff2d55',
                            'elevated': '#ff9500', 'watch': '#ffcc00', 'monitor': '#34c759',
                        }
                    },
                    fontFamily: { 'mono': ['JetBrains Mono', 'monospace'], 'display': ['Space Grotesk', 'sans-serif'] },
                }
            }
        }
    </script>
    
    <style>
        * { scrollbar-width: thin; scrollbar-color: #1b2430 #0a0e12; }
        .leaflet-container { background: #0a0e12 !important; }
        .leaflet-control-zoom { display: none; }
        .leaflet-popup-content-wrapper { background: #0d1117 !important; border: 1px solid #00ff88 !important; border-radius: 8px !important; color: #e6edf3 !important; }
        .leaflet-popup-tip { background: #0d1117 !important; }
        .grid-bg { background-image: linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px); background-size: 40px 40px; }
        .feed-item { border-left: 3px solid transparent; transition: all 0.15s; }
        .feed-item:hover { background: rgba(0,255,136,0.05); border-left-color: #00ff88; }
        .feed-item.critical { border-left-color: #ff2d55; }
        .feed-item.elevated { border-left-color: #ff9500; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .ticker { animation: ticker 45s linear infinite; }
        @keyframes load { 0% { width: 0; } 100% { width: 100%; } }
        .load-bar { animation: load 2s ease-out forwards; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-p-black text-p-text font-mono">
    <div id="loader" class="fixed inset-0 bg-p-black z-50 flex flex-col items-center justify-center">
        <div class="absolute inset-0 grid-bg opacity-40"></div>
        <div class="relative z-10 text-center">
            <h1 class="font-display text-5xl md:text-6xl font-bold tracking-[0.3em] text-p-green mb-2" style="text-shadow: 0 0 30px rgba(0,255,136,0.5)">PULSE</h1>
            <p class="text-xs text-p-muted tracking-widest mb-10">GLOBAL INTELLIGENCE MONITOR</p>
            <div class="w-64 h-1 bg-p-border rounded-full overflow-hidden mb-4">
                <div class="h-full bg-p-green load-bar"></div>
            </div>
            <p class="text-xs text-p-green" id="load-status">INITIALIZING...</p>
        </div>
    </div>
    
    <div id="root">
        <div style="color: #ff2d55; padding: 80px 20px; text-align: center; font-family: monospace;">
            If you see this after loader ‚Üí render failed. Check console (F12).
        </div>
    </div>
    
    <script>
        var loadMsgs = ['INITIALIZING...', 'CONNECTING FEEDS...', 'LOADING DATA...', 'READY'];
        var loadIdx = 0;
        var loadInterval = setInterval(function() {
            loadIdx++;
            if (loadIdx < loadMsgs.length) document.getElementById('load-status').textContent = loadMsgs[loadIdx];
        }, 500);
        
        setTimeout(function() {
            clearInterval(loadInterval);
            document.getElementById('loader').style.display = 'none';
        }, 2500);
    </script>
    
    <script type="text/babel">
        const DEFCON = { 1: { n: 'COCKED PISTOL', d: 'Nuclear war imminent', c: '#ff2d55' }, 2: { n: 'FAST PACE', d: 'Next step to nuclear war', c: '#ff3b30' }, 3: { n: 'ROUND HOUSE', d: 'Air Force ready 15 min', c: '#ff9500' }, 4: { n: 'DOUBLE TAKE', d: 'Above normal', c: '#5ac8fa' }, 5: { n: 'FADE OUT', d: 'Normal readiness', c: '#34c759' } };
        
        const ZONES = [ /* unchanged - your full ZONES array here, I'm omitting for brevity but keep it as-is */ ];

        const fmtTime = () => new Date().toLocaleString('en-US', { timeZone: 'UTC', weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) + ' UTC';
        const timeAgo = d => { const s = Math.floor((Date.now() - new Date(d)) / 1000); return s < 60 ? 'now' : s < 3600 ? Math.floor(s/60)+'m' : s < 86400 ? Math.floor(s/3600)+'h' : Math.floor(s/86400)+'d'; };
        const newsLevel = t => { const l = t.toLowerCase(); return /killed|dead|attack|strike|war|crisis|missile/.test(l) ? 'critical' : /military|troops|tension|nuclear|protest/.test(l) ? 'elevated' : 'watch'; };

        const Header = ({ time }) => ( /* unchanged */ );
        const DefconBar = () => ( /* unchanged */ );
        const Ticker = () => ( /* unchanged */ );
        const Panel = ({ title, badge, color = 'cyan', children }) => ( /* unchanged */ );
        const Map = () => { /* unchanged - keep your Map component as-is */ };
        const FeedItem = ({ item }) => ( /* unchanged */ );
        const OsintPanel = () => ( /* unchanged */ );
        const TwitterPanel = () => ( /* unchanged */ );
        const MarketsPanel = () => ( /* unchanged */ );

        const App = () => {
            const [time, setTime] = React.useState(fmtTime());
            React.useEffect(() => {
                const t = setInterval(() => setTime(fmtTime()), 1000);
                return () => clearInterval(t);
            }, []);

            // Inline news fetching (was useNews)
            const [bbcItems, setBbcItems] = React.useState([]);
            const [bbcLoading, setBbcLoading] = React.useState(true);
            const [ajItems, setAjItems] = React.useState([]);
            const [ajLoading, setAjLoading] = React.useState(true);

            React.useEffect(() => {
                const loadFeed = async (url, setItems, setLoading, src) => {
                    try {
                        const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                        const d = await r.json();
                        if (d.status === 'ok' && d.items) {
                            setItems(d.items.slice(0,8).map(i => ({
                                time: timeAgo(i.pubDate), src, text: i.title?.replace(/<[^>]*>/g,''), link: i.link, level: newsLevel(i.title || '')
                            })));
                        }
                    } catch (e) { console.warn('Feed fetch failed:', e); }
                    setLoading(false);
                };

                loadFeed('https://feeds.bbci.co.uk/news/world/rss.xml', setBbcItems, setBbcLoading, 'BBC');
                loadFeed('https://www.aljazeera.com/xml/rss/all.xml', setAjItems, setAjLoading, 'AJ');

                const int1 = setInterval(() => loadFeed('https://feeds.bbci.co.uk/news/world/rss.xml', setBbcItems, setBbcLoading, 'BBC'), 120000);
                const int2 = setInterval(() => loadFeed('https://www.aljazeera.com/xml/rss/all.xml', setAjItems, setAjLoading, 'AJ'), 120000);

                return () => { clearInterval(int1); clearInterval(int2); };
            }, []);

            // Inline Polymarket fetching (was usePolymarket)
            const [polyData, setPolyData] = React.useState([
                { q: 'Russia-Ukraine Ceasefire Jan 31?', p: 3, v: '$16M' }, /* fallback */
                // ... your other fallback items
            ]);

            React.useEffect(() => {
                const loadPoly = async () => {
                    try {
                        const r = await fetch('https://gamma-api.polymarket.com/markets?closed=false&limit=100');
                        const m = await r.json();
                        const kw = ['ukraine','russia','iran','china','taiwan','israel','fed','ceasefire','regime','shutdown'];
                        const f = m.filter(x => kw.some(k => x.question?.toLowerCase().includes(k))).slice(0,10);
                        if (f.length > 0) setPolyData(f.map(x => ({
                            q: x.question, p: Math.round(parseFloat(x.outcomePrices?.[0]||0)*100),
                            v: `$${(parseFloat(x.volume||0)/1e6).toFixed(1)}M`
                        })));
                    } catch (e) { console.warn('Poly fetch failed:', e); }
                };
                loadPoly();
                const t = setInterval(loadPoly, 60000);
                return () => clearInterval(t);
            }, []);

            return (
                <div className="min-h-screen bg-p-black">
                    <Header time={time} />
                    <DefconBar />
                    <Ticker />
                    <main className="p-3 max-w-[1920px] mx-auto">
                        <section className="mb-4">
                            <div className="flex items-center gap-2 mb-2">
                                <span>üåç</span>
                                <span className="font-display font-semibold">GLOBAL SITUATION</span>
                                <span className="px-2 py-0.5 bg-p-green/20 text-p-green text-xs rounded pulse">LIVE</span>
                            </div>
                            <Map />
                        </section>
                        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3">
                            <div className="space-y-3">
                                <OsintPanel />
                                <TwitterPanel />
                            </div>
                            <div className="space-y-3">
                                <Panel title="üì∞ BBC WORLD" badge={bbcLoading ? '...' : 'LIVE'}>
                                    {bbcItems.length > 0 ? <div className="space-y-1">{bbcItems.map((d,i) => <FeedItem key={i} item={d} />)}</div> : <p className="text-xs text-p-muted text-center py-4">{bbcLoading ? 'Loading...' : 'Feed unavailable'}</p>}
                                </Panel>
                                <Panel title="üåê AL JAZEERA" badge={ajLoading ? '...' : 'LIVE'}>
                                    {ajItems.length > 0 ? <div className="space-y-1">{ajItems.map((d,i) => <FeedItem key={i} item={d} />)}</div> : <p className="text-xs text-p-muted text-center py-4">{ajLoading ? 'Loading...' : 'Feed unavailable'}</p>}
                                </Panel>
                            </div>
                            <div className="space-y-3">
                                <Panel title="üìä POLYMARKET" badge="LIVE">
                                    <div className="space-y-2">
                                        {polyData.map((d, i) => {
                                            const c = d.p >= 50 ? '#ef4444' : d.p >= 25 ? '#f97316' : '#34c759';
                                            return (
                                                <div key={i} className="bg-p-dark rounded p-2 border border-p-border/50">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-xs pr-2">{d.q}</span>
                                                        <span className="text-lg font-bold" style={{ color: c }}>{d.p}%</span>
                                                    </div>
                                                    <div className="h-1.5 bg-p-border rounded-full overflow-hidden">
                                                        <div className="h-full rounded-full" style={{ width: `${d.p}%`, background: c }}></div>
                                                    </div>
                                                    <div className="text-xs text-p-muted mt-1">Vol: {d.v}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <a href="https://polymarket.com" target="_blank" rel="noopener noreferrer" className="block mt-3 pt-2 border-t border-p-border text-xs text-p-cyan hover:underline">All markets ‚Üí</a>
                                </Panel>
                                <MarketsPanel />
                            </div>
                        </div>
                        <footer className="mt-6 pt-3 border-t border-p-border text-center text-xs text-p-muted">
                            <p>PULSE v2.4 ‚Ä¢ OSINT Dashboard</p>
                            <div className="flex justify-center gap-3 mt-1">
                                <a href="https://defconlevel.com" target="_blank" rel="noopener noreferrer" className="text-p-cyan hover:underline">DEFCON</a>
                                <a href="https://polymarket.com" target="_blank" rel="noopener noreferrer" className="text-p-cyan hover:underline">Polymarket</a>
                                <a href="https://understandingwar.org" target="_blank" rel="noopener noreferrer" className="text-p-cyan hover:underline">ISW</a>
                            </div>
                        </footer>
                    </main>
                </div>
            );
        };

        setTimeout(() => {
            try {
                ReactDOM.createRoot(document.getElementById('root')).render(<App />);
                console.log("PULSE dashboard rendered successfully");
            } catch (err) {
                console.error("Render failed:", err);
                document.getElementById('root').innerHTML = `<div style="color:#ff2d55;padding:40px;text-align:center;font-family:monospace;"><h2>Render Error</h2><pre style="background:#0a0e12;padding:16px;border-radius:8px;overflow:auto;max-width:90%;margin:20px auto;">${err.message}</pre><p>Check console (F12)</p></div>`;
            }
        }, 300);  // Slightly longer delay helps in some browsers
    </script>
</body>
</html>
